name: HACKER_VPS_PROVISIONING

on:
  repository_dispatch:
    types: [start-sshx]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 360 

    steps:
      - name: üõ†Ô∏è INITIALIZING VPS SYSTEM
        run: |
          echo ">>> [STATUS] PROVISIONING VPS CORE..."
          sudo apt-get update > /dev/null 2>&1
          
      - name: üöÄ DEPLOY TERMINAL GATEWAY
        run: |
          # 1. T·∫£i v√† c√†i ƒë·∫∑t sshx
          curl -sSf https://sshx.io/get | sh
          
          # 2. Kh·ªüi ch·∫°y sshx v√† ghi log, k·∫øt h·ª£p chuy·ªÉn h∆∞·ªõng l·ªói ƒë·ªÉ debug
          echo ">>> [SYSTEM] STARTING TUNNEL SERVICE..."
          ./sshx > sshx_output.log 2>&1 &
          
          # 3. ƒê·ª£i l√¢u h∆°n m·ªôt ch√∫t (20 gi√¢y) ƒë·ªÉ tunnel ·ªïn ƒë·ªãnh
          sleep 20
          
          # 4. Ki·ªÉm tra xem file log c√≥ n·ªôi dung kh√¥ng
          if [ ! -s sshx_output.log ]; then
            echo ">>> [ERROR] SSHX_OUTPUT_LOG_IS_EMPTY"
            exit 1
          fi

          # 5. Tr√≠ch xu·∫•t link v·ªõi Regex linh ho·∫°t h∆°n
          echo ">>> [ACCESS_LINK_START]"
          # S·ª≠ d·ª•ng '-a' ƒë·ªÉ x·ª≠ l√Ω file log nh∆∞ text v√† l·ªçc link
          LINK=$(grep -ao 'https://sshx.io/s/[a-zA-Z0-9]*' sshx_output.log | head -n 1)
          
          if [ -z "$LINK" ]; then
            echo "FAILED_TO_GENERATE_LINK"
            cat sshx_output.log # In to√†n b·ªô log ra ƒë·ªÉ xem l·ªói th·∫≠t s·ª± l√† g√¨
            exit 1
          else
            echo "$LINK"
          fi
          echo ">>> [ACCESS_LINK_END]"
          
          echo "------------------------------------------------------------"
          echo ">>> [STATUS] VPS ACTIVE FOR 4 HOURS"
          echo "------------------------------------------------------------"
          
          # Gi·ªØ m√°y ·∫£o s·ªëng
          sleep 14400
