name: HACKER_VM_PROVISIONING

on:
  repository_dispatch:
    types: [start-sshx] # Láº¯ng nghe tÃ­n hiá»‡u tá»« server.js

jobs:
  deploy:
    runs-on: ubuntu-latest
    # Giá»›i háº¡n thá»i gian cháº¡y tá»‘i Ä‘a Ä‘á»ƒ trÃ¡nh láº¡m dá»¥ng tÃ i nguyÃªn (6 tiáº¿ng)
    timeout-minutes: 360 

    steps:
      - name: ðŸ› ï¸ INITIALIZING SYSTEM
        run: |
          echo ">>> [STATUS] STARTING VIRTUAL MACHINE CORE..."
          echo ">>> [TARGET_OPERATOR] ${{ github.event.client_payload.username }}"
          sudo apt-get update > /dev/null 2>&1
          
      - name: ðŸš€ DEPLOY TERMINAL GATEWAY (SSHX)
        run: |
          # CÃ i Ä‘áº·t sshx tá»« trang chá»§
          curl -sSf https://sshx.io/get | sh
          
          echo "------------------------------------------------------------"
          echo ">>> [SECURITY] ESTABLISHING ENCRYPTED TUNNEL..."
          echo "------------------------------------------------------------"
          
          # Cháº¡y sshx trong ná»n vÃ  ghi log ra file táº¡m
          ./sshx > sshx_output.log 2>&1 &
          
          # Äá»£i 10 giÃ¢y Ä‘á»ƒ Ä‘áº£m báº£o tunnel Ä‘Æ°á»£c khá»Ÿi táº¡o thÃ nh cÃ´ng
          sleep 10
          
          # TRÃCH XUáº¤T LINK (DÃ²ng nÃ y cá»±c ká»³ quan trá»ng Ä‘á»ƒ server.js quÃ©t Ä‘Æ°á»£c)
          echo ">>> [ACCESS_LINK_START]"
          grep -o 'https://sshx.io/s/[a-zA-Z0-9]*' sshx_output.log
          echo ">>> [ACCESS_LINK_END]"
          
          echo "------------------------------------------------------------"
          echo ">>> [STATUS] VM IS NOW ACTIVE FOR 4 HOURS"
          echo ">>> [NOTICE] DO NOT CLOSE THIS JOB TO KEEP VM ALIVE"
          echo "------------------------------------------------------------"
          
          # Giá»¯ workflow cháº¡y liÃªn tá»¥c trong 4 tiáº¿ng (14400 giÃ¢y)
          sleep 14400

      - name: ðŸ›‘ SYSTEM TERMINATION
        if: always()
        run: echo ">>> [CLEANUP] VM DECOMMISSIONED SUCCESSFULLY."
