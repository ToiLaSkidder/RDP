name: HACKER_VPS_PROVISIONING

on:
  repository_dispatch:
    types: [start-sshx]

jobs:
  deploy:
    runs-on: ubuntu-latest
    timeout-minutes: 360 

    steps:
      - name: ðŸ› ï¸ INITIALIZING VPS SYSTEM
        run: |
          echo ">>> [STATUS] PROVISIONING VPS CORE..."
          sudo apt-get update > /dev/null 2>&1
          
      - name: ðŸš€ DEPLOY TERMINAL GATEWAY
        run: |
          # 1. Táº£i sshx vÃ  Ã©p buá»™c cÃ i Ä‘áº·t vÃ o thÆ° má»¥c hiá»‡n táº¡i
          echo ">>> [SYSTEM] DOWNLOADING SSHX..."
          curl -sSf https://sshx.io/get | sh
          
          # 2. Kiá»ƒm tra vá»‹ trÃ­ file vÃ  cáº¥p quyá»n thá»±c thi
          # ThÆ°á»ng thÃ¬ lá»‡nh trÃªn cÃ i vÃ o /usr/local/bin hoáº·c thÆ° má»¥c hiá»‡n táº¡i
          # ChÃºng ta sáº½ copy nÃ³ ra thÆ° má»¥c lÃ m viá»‡c Ä‘á»ƒ quáº£n lÃ½
          if [ -f "/usr/local/bin/sshx" ]; then
            cp /usr/local/bin/sshx ./sshx
          fi
          chmod +x ./sshx
          
          # 3. Khá»Ÿi cháº¡y service
          echo ">>> [SYSTEM] STARTING TUNNEL SERVICE..."
          ./sshx > sshx_output.log 2>&1 &
          
          # 4. Äá»£i tunnel khá»Ÿi táº¡o
          sleep 20
          
          # 5. Kiá»ƒm tra log vÃ  trÃ­ch xuáº¥t link
          echo ">>> [ACCESS_LINK_START]"
          if [ -f sshx_output.log ]; then
            LINK=$(grep -ao 'https://sshx.io/s/[a-zA-Z0-9]*' sshx_output.log | head -n 1)
            if [ -z "$LINK" ]; then
              echo "FAILED_TO_GENERATE_LINK"
              echo "--- DEBUG LOG CONTENT ---"
              cat sshx_output.log
              exit 1
            else
              echo "$LINK"
            fi
          else
            echo "LOG_FILE_NOT_FOUND"
            exit 1
          fi
          echo ">>> [ACCESS_LINK_END]"
          
          echo "------------------------------------------------------------"
          echo ">>> [STATUS] VPS ACTIVE FOR 4 HOURS"
          echo "------------------------------------------------------------"
          
          sleep 14400
