name: üöÄ SSHX TERMINAL - WORKER REDIRECT (DYNAMIC TIME)

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'üïê Ch·ªçn th·ªùi gian duy tr√¨'
        required: false
        default: '12h'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '6h'
        - '12h'

jobs:
  SSHX-to-Worker:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• C√ÄI ƒê·∫∂T SSHX (B·∫¢N FIX)
        run: |
          # 1. X√≥a file l·ªói c≈© n·∫øu c√≥
          rm -rf sshx
          
          # 2. C√†i ƒë·∫∑t b·∫±ng script ch√≠nh ch·ªß
          curl -sSf https://sshx.io/get | sh
          
          # 3. T√¨m v√† copy file ch·∫°y ra th∆∞ m·ª•c hi·ªán t·∫°i
          # Script th∆∞·ªùng c√†i v√†o ~/.sshx/sshx ho·∫∑c /usr/local/bin/sshx
          if [ -f "$HOME/.sshx/sshx" ]; then
            cp "$HOME/.sshx/sshx" .
            echo "‚úÖ ƒê√£ l·∫•y file t·ª´ th∆∞ m·ª•c Home"
          elif [ -f "/usr/local/bin/sshx" ]; then
            cp "/usr/local/bin/sshx" .
            echo "‚úÖ ƒê√£ l·∫•y file t·ª´ /usr/local/bin"
          else
            # Tr∆∞·ªùng h·ª£p d·ª± ph√≤ng: T√¨m kh·∫Øp n∆°i
            find $HOME -name sshx -type f -exec cp {} . \; -quit
          fi
          
          # 4. C·∫•p quy·ªÅn ch·∫°y cho ch·∫Øc ch·∫Øn
          chmod +x ./sshx
          ls -lh ./sshx

      - name: üåê KH·ªûI CH·∫†Y V√Ä C·∫¨P NH·∫¨T WORKER KV
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          KV_ID: ${{ secrets.KV_NAMESPACE_ID }}
        run: |
          # 1. Kh·ªüi ch·∫°y sshx
          ./sshx > sshx_log.txt 2>&1 &
          
          echo "‚è≥ ƒêang kh·ªüi t·∫°o phi√™n l√†m vi·ªác..."
          sleep 5
          
          # 2. Ki·ªÉm tra log
          cat sshx_log.txt
          
          # 3. Tr√≠ch xu·∫•t URL (L·ªçc k·ªπ h∆°n ƒë·ªÉ tr√°nh l·∫•y nh·∫ßm)
          SSHX_URL=$(grep -o 'https://sshx.io/s/[a-zA-Z0-9]*' sshx_log.txt | head -n 1)
          
          if [ -z "$SSHX_URL" ]; then
            echo "‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y URL trong log!"
            exit 1
          fi

          echo "üîó URL t√¨m th·∫•y: $SSHX_URL"

          # 4. ƒê·∫©y URL l√™n Cloudflare KV
          curl -s -X PUT "https://api.cloudflare.com/client/v4/accounts/$CF_ACCOUNT_ID/storage/kv/namespaces/$KV_ID/values/LATEST_URL" \
            -H "Authorization: Bearer $CF_API_TOKEN" \
            -H "Content-Type: text/plain" \
            --data "$SSHX_URL"
          
          echo "‚úÖ ƒê√£ c·∫≠p nh·∫≠t Worker Redirect th√†nh c√¥ng!"

      - name: ‚è≥ DUY TR√å H·ªÜ TH·ªêNG
        run: |
          DURATION="${{ github.event.inputs.duration }}"
          echo "üïí Th·ªùi gian c·∫•u h√¨nh: $DURATION"
          
          case $DURATION in
            "1h") sleep 3600 ;;
            "3h") sleep 10800 ;;
            "6h") sleep 21600 ;;
            "12h") sleep 43200 ;;
            *) sleep 3600 ;;
          esac
