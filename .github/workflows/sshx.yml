name: ğŸš€ SSHX TERMINAL - WORKER REDIRECT (DYNAMIC TIME)

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'ğŸ• Chá»n thá»i gian duy trÃ¬'
        required: false
        default: '12h'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '6h'
        - '12h'

jobs:
  SSHX-to-Worker:
    runs-on: ubuntu-latest
    
    steps:
      - name: ğŸ“¥ CÃ€I Äáº¶T SSHX
        run: curl -sSf https://sshx.io/get | sh

      - name: ğŸŒ KHá»I CHáº Y VÃ€ Cáº¬P NHáº¬T WORKER KV
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          KV_ID: ${{ secrets.KV_NAMESPACE_ID }}
        run: |
          # 1. Khá»Ÿi cháº¡y sshx trong ná»n
          ./sshx > sshx_log.txt 2>&1 &
          sleep 10
          
          # 2. TrÃ­ch xuáº¥t URL sshx
          SSHX_URL=$(grep -o 'https://sshx.io/s/[a-zA-Z0-9]*' sshx_log.txt | head -n 1)
          
          if [ -z "$SSHX_URL" ]; then
            echo "âŒ Lá»—i: KhÃ´ng láº¥y Ä‘Æ°á»£c URL tá»« SSHX!"
            cat sshx_log.txt
            exit 1
          fi

          echo "ğŸ”— URL má»›i: $SSHX_URL"

          # 3. Äáº©y URL lÃªn Cloudflare KV
          curl -s -X PUT "https://api.cloudflare.com/client/v4/accounts/$CF_ACCOUNT_ID/storage/kv/namespaces/$KV_ID/values/LATEST_URL" \
            -H "Authorization: Bearer $CF_API_TOKEN" \
            -H "Content-Type: text/plain" \
            --data "$SSHX_URL"
          
          echo "âœ… ÄÃ£ cáº­p nháº­t Worker Redirect thÃ nh cÃ´ng!"

      - name: â³ DUY TRÃŒ Há»† THá»NG
        run: |
          DURATION="${{ github.event.inputs.duration }}"
          echo "ğŸ•’ Thá»i gian Ä‘ang cháº¡y: $DURATION"
          
          case $DURATION in
            "1h") sleep 3600 ;;
            "3h") sleep 10800 ;;
            "6h") sleep 21600 ;;
            "12h") sleep 43200 ;;
            *) sleep 3600 ;;
          esac
          
          echo "ğŸ¯ ÄÃ£ háº¿t thá»i gian phiÃªn lÃ m viá»‡c."
