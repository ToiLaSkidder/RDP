name: üöÄ SSHX ULTRA CLEAN REDIRECT

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'üïê Th·ªùi gian ch·∫°y (1h-12h)'
        default: '12h'
        type: choice
        options: ['1h', '3h', '6h', '12h']

jobs:
  Fast-Deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: üì• CHECKOUT
        uses: actions/checkout@v4

      - name: üì• SETUP SSHX BINARY
        run: |
          curl -sSf https://sshx.io/get | sh
          # T√¨m file th·ª±c thi b·∫•t k·ªÉ script c√†i ƒë·∫∑t ƒë·∫∑t n√≥ ·ªü ƒë√¢u
          SSHX_PATH=$(which sshx || find $HOME -name sshx -type f | head -n 1)
          cp "$SSHX_PATH" ./sshx_bin
          chmod +x ./sshx_bin

      - name: üåê RUN ROOT & PURGE ANSI LOGS
        run: |
          # Ch·∫°y sudo ƒë·ªÉ c√≥ quy·ªÅn qu·∫£n tr·ªã cao nh·∫•t
          sudo ./sshx_bin > sshx_log.txt 2>&1 &
          
          echo "‚è≥ ƒêang kh·ªüi t·∫°o Terminal (15s)..."
          sleep 15
          
          # L·ªçc URL v√† t·∫©y s·∫°ch m√£ m√†u ANSI (\x1b...) g√¢y l·ªói "Invalid end-to-end"
          RAW_URL=$(grep -o 'https://sshx.io/s/[^[:space:]]*' sshx_log.txt | head -n 1 | sed 's/\x1b\[[0-9;]*m//g')
          
          # C·∫Øt b·ªè c√°c k√Ω t·ª± r√°c kh√¥ng ph·∫£i URL ·ªü cu·ªëi d√≤ng
          CLEAN_URL=$(echo "$RAW_URL" | sed 's/[^a-zA-Z0-9#?=&/_.:-]*$//')

          if [ -z "$CLEAN_URL" ]; then
            echo "‚ùå L·ªói: Kh√¥ng b·∫Øt ƒë∆∞·ª£c URL SSHX!"
            cat sshx_log.txt
            exit 1
          fi

          echo "‚úÖ URL CHU·∫®N: $CLEAN_URL"
          echo "$CLEAN_URL" > url_source.txt

      - name: ‚ö° DEPLOY TO GH-PAGES WITH CACHE BYPASS
        run: |
          SSHX_URL=$(cat url_source.txt)
          
          # T·∫°o trang index.html v·ªõi logic t·ª± ƒë·ªông redirect qua ?new ƒë·ªÉ x√≥a cache
          cat <<EOF > index.html
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="UTF-8">
              <title>ToiLaSkidder Terminal</title>
              <script>
                  const params = new URLSearchParams(window.location.search);
                  if (!params.has('new')) {
                      // B∆∞·ªõc 1: Th√™m ?new ƒë·ªÉ GitHub Pages kh√¥ng load b·∫£n c≈©
                      window.location.replace(window.location.origin + window.location.pathname + '?new');
                  } else {
                      // B∆∞·ªõc 2: Redirect t·ªõi link SSHX th·∫≠t s·ª±
                      window.location.replace("$SSHX_URL");
                  }
              </script>
          </head>
          <body style="background:#000;color:#0f0;font-family:monospace;display:flex;justify-content:center;align-items:center;height:100vh;margin:0;">
              <div style="border:1px solid #0f0;padding:20px;box-shadow:0 0 10px #0f0;">
                  > LOADING ROOT ACCESS...<br>
                  > BYPASSING CACHE...<br>
                  > REDIRECTING TO TERMINAL...
              </div>
          </body>
          </html>
          EOF
          
          # C·∫•u h√¨nh domain v√† bypass Jekyll
          echo "sshx.nghuyzzz.qzz.io" > CNAME
          touch .nojekyll
          
          # Git Push Fast
          git config --global user.name "ToiLaSkidder"
          git config --global user.email "ToiLaSkidder@users.noreply.github.com"
          
          git checkout --orphan gh-pages
          git rm -rf .
          git add index.html CNAME .nojekyll
          git commit -m "üöÄ Terminal Updated: $(date)"
          git push origin gh-pages --force

      - name: ‚è≥ KEEP ALIVE
        run: |
          echo "üïí H·ªá th·ªëng ƒëang ch·∫°y trong ${{ github.event.inputs.duration }}..."
          case "${{ github.event.inputs.duration }}" in
            "1h") sleep 3600 ;; "3h") sleep 10800 ;; "6h") sleep 21600 ;; "12h") sleep 43200 ;;
          esac
