name: üöÄ SSHX MATRIX ULTIMATE FIX

on:
  workflow_dispatch:
    inputs:
      duration:
        default: '12h'
        type: choice
        options: ['1h', '3h', '6h', '12h']

jobs:
  Deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: üì• CHECKOUT
        uses: actions/checkout@v4

      - name: üì• C√ÄI ƒê·∫∂T SSHX (T·∫¢I TR·ª∞C TI·∫æP BINARY)
        run: |
          # X√°c ƒë·ªãnh ki·∫øn tr√∫c m√°y (th∆∞·ªùng l√† x86_64 tr√™n GitHub Runner)
          # T·∫£i b·∫£n m·ªõi nh·∫•t tr·ª±c ti·∫øp t·ª´ server sshx
          curl -sSfL -o sshx_bin https://sshx.io/get | sh
          
          # N·∫øu l·ªánh tr√™n ch·ªâ ch·∫°y script, ta s·∫Ω l·∫•y file t·ª´ th∆∞ m·ª•c c√†i ƒë·∫∑t m·∫∑c ƒë·ªãnh c·ªßa n√≥
          if [ ! -f "./sshx_bin" ]; then
             # T√¨m ki·∫øm m·ªçi file t√™n sshx nh∆∞ng lo·∫°i tr·ª´ c√°c th∆∞ m·ª•c h·ªá th·ªëng kh√¥ng c·∫ßn thi·∫øt
             FOUND_PATH=$(which sshx || find /home/runner -name sshx -type f -executable | head -n 1)
             cp "$FOUND_PATH" ./sshx_bin
          fi
          
          chmod +x ./sshx_bin
          echo "‚úÖ ƒê√£ t√¨m th·∫•y v√† c·∫•p quy·ªÅn cho: ./sshx_bin"

      - name: üåê L·∫§Y URL V√Ä FIX L·ªñI ANSI
        run: |
          # Ch·∫°y v·ªõi quy·ªÅn root
          sudo ./sshx_bin > sshx_log.txt 2>&1 &
          sleep 15
          
          # L·ªçc link: x√≥a m√£ m√†u ANSI v√† l·∫•y chu·∫©n fragment #
          RAW_URL=$(grep -o 'https://sshx.io/s/[^[:space:]]*' sshx_log.txt | head -n 1 | sed 's/\x1b\[[0-9;]*m//g')
          
          # L√†m s·∫°ch link: Ch·ªâ gi·ªØ 1 d·∫•u # duy nh·∫•t
          CLEAN_URL=$(echo "$RAW_URL" | sed 's/\(#.*\)\1/\1/g' | sed 's/[^a-zA-Z0-9#?=&/_.:-]*$//')
          
          echo "URL_FINAL=$CLEAN_URL" >> $GITHUB_ENV
          echo "‚úÖ URL ƒê√É FIX: $CLEAN_URL"

      - name: ‚ö° DEPLOY MATRIX INTERFACE
        run: |
          VERSION=$(date +%s)
          cat <<EOF > index.html
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="UTF-8">
              <title>SYSTEM OVERRIDE | TOILASKIDDER</title>
              <style>
                  canvas { display: block; position: fixed; top: 0; left: 0; z-index: -1; }
                  body { background: #000; color: #0f0; font-family: 'Courier New', monospace; margin: 0; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
                  .panel { background: rgba(0, 20, 0, 0.8); border: 2px solid #0f0; padding: 30px; box-shadow: 0 0 30px #0f0; text-align: left; min-width: 400px; z-index: 1; }
                  .line { margin: 10px 0; font-size: 16px; border-right: 2px solid #0f0; animation: blink 0.5s step-end infinite; }
                  @keyframes blink { 50% { border-color: transparent } }
              </style>
          </head>
          <body>
              <canvas id="matrix"></canvas>
              <div class="panel">
                  <div class="line">> ACCESSING SERVER... [DONE]</div>
                  <div class="line">> BYPASSING CACHE: $VERSION</div>
                  <div class="line">> ESTABLISHING ROOT SSHX...</div>
                  <div id="status" style="margin-top:20px; font-weight:bold;">REDIRECTING...</div>
              </div>
              <script>
                  // Hi·ªáu ·ª©ng Matrix
                  const canvas = document.getElementById('matrix');
                  const ctx = canvas.getContext('2d');
                  canvas.width = window.innerWidth; canvas.height = window.innerHeight;
                  const letters = "01";
                  const fontSize = 16;
                  const columns = canvas.width / fontSize;
                  const drops = Array(Math.floor(columns)).fill(1);
                  function draw() {
                      ctx.fillStyle = 'rgba(0, 0, 0, 0.05)'; ctx.fillRect(0, 0, canvas.width, canvas.height);
                      ctx.fillStyle = '#0f0'; ctx.font = fontSize + 'px monospace';
                      for (let i = 0; i < drops.length; i++) {
                          const text = letters.charAt(Math.floor(Math.random() * letters.length));
                          ctx.fillText(text, i * fontSize, drops[i] * fontSize);
                          if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) drops[i] = 0;
                          drops[i]++;
                      }
                  }
                  setInterval(draw, 33);

                  // Auto Redirect + Cache Buster
                  const urlParams = new URLSearchParams(window.location.search);
                  if (!urlParams.has('v')) {
                      setTimeout(() => { window.location.replace(window.location.origin + window.location.pathname + '?v=$VERSION'); }, 1500);
                  } else {
                      setTimeout(() => { window.location.replace("${{ env.URL_FINAL }}"); }, 2000);
                  }
              </script>
          </body>
          </html>
          EOF
          
          echo "sshx.nghuyzzz.qzz.io" > CNAME
          touch .nojekyll
          git config --global user.name "ToiLaSkidder"
          git config --global user.email "ToiLaSkidder@users.noreply.github.com"
          git checkout --orphan gh-pages
          git rm -rf .
          git add index.html CNAME .nojekyll
          git commit -m "üöÄ Matrix Fix Deploy: $VERSION"
          git push origin gh-pages --force

      - name: ‚è≥ KEEP ALIVE
        run: |
          echo "üïí Uptime: ${{ github.event.inputs.duration }}"
          case "${{ github.event.inputs.duration }}" in
            "1h") sleep 3600 ;; "3h") sleep 10800 ;; "6h") sleep 21600 ;; "12h") sleep 43200 ;;
          esac
