name: üöÄ SSHX FINAL REWRITE FOR TOILASKIDDER

on:
  workflow_dispatch:
    inputs:
      duration:
        default: '12h'
        type: choice
        options: ['1h', '3h', '6h', '12h']

jobs:
  Deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: üì• CHECKOUT
        uses: actions/checkout@v4

      - name: üì• C√ÄI ƒê·∫∂T SSHX
        run: |
          curl -sSf https://sshx.io/get | sh
          SSHX_BIN=$(which sshx || find $HOME -name sshx -type f | head -n 1)
          cp "$SSHX_BIN" ./sshx_bin

      - name: üåê L·∫§Y URL V√Ä L√ÄM S·∫†CH TUY·ªÜT ƒê·ªêI
        run: |
          sudo ./sshx_bin > sshx_log.txt 2>&1 &
          sleep 15
          
          # 1. L·∫•y link th√¥ v√† x√≥a m√£ m√†u ANSI
          RAW_URL=$(grep -o 'https://sshx.io/s/[^[:space:]]*' sshx_log.txt | head -n 1 | sed 's/\x1b\[[0-9;]*m//g')
          
          # 2. X·ª≠ l√Ω l·ªói l·∫∑p d·∫•u # (Ch·ªâ l·∫•y ƒë·∫øn d·∫•u # th·ª© hai th√¨ d·ª´ng l·∫°i)
          # Logic: T√°ch link t·∫°i d·∫•u # v√† ch·ªâ gi·ªØ l·∫°i ph·∫ßn ID ƒë·∫ßu ti√™n
          BASE_PART=$(echo "$RAW_URL" | cut -d'#' -f1)
          TOKEN_PART=$(echo "$RAW_URL" | cut -d'#' -f2)
          CLEAN_URL="${BASE_PART}#${TOKEN_PART}"
          
          # 3. Lo·∫°i b·ªè k√Ω t·ª± l·∫° cu·ªëi c√πng
          FINAL_URL=$(echo "$CLEAN_URL" | sed 's/[^a-zA-Z0-9#?=&/_.:-]*$//')

          echo "‚úÖ URL ƒê√É FIX: $FINAL_URL"
          echo "$FINAL_URL" > url_source.txt

      - name: ‚ö° PUSH ƒê√à NH√ÅNH ƒê·ªÇ C·∫¨P NH·∫¨T PAGES
        run: |
          SSHX_URL=$(cat url_source.txt)
          TS=$(date +%s)
          
          # T·∫°o trang redirect s·∫°ch
          cat <<EOF > index.html
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="UTF-8">
              <title>Terminal Loading...</title>
              <script>
                  // Ph√° cache b·∫±ng timestamp v√† redirect
                  const target = "$SSHX_URL";
                  window.location.replace(target);
              </script>
          </head>
          <body style="background:#000;color:#0f0;text-align:center;padding-top:20%;font-family:monospace;">
              > INITIALIZING CLEAN SESSION: $TS
          </body>
          </html>
          EOF
          
          echo "sshx.nghuyzzz.qzz.io" > CNAME
          touch .nojekyll
          
          git config --global user.name "ToiLaSkidder"
          git config --global user.email "ToiLaSkidder@users.noreply.github.com"
          
          # √âp GitHub Pages c·∫≠p nh·∫≠t b·∫±ng c√°ch x√≥a v√† ƒë·∫©y m·ªõi
          git checkout --orphan gh-pages
          git rm -rf .
          git add index.html CNAME .nojekyll
          git commit -m "üöÄ Fix duplicated URL & Cache: $TS"
          git push origin gh-pages --force

      - name: ‚è≥ KEEP ALIVE
        run: |
          case "${{ github.event.inputs.duration }}" in
            "1h") sleep 3600 ;; "3h") sleep 10800 ;; "6h") sleep 21600 ;; "12h") sleep 43200 ;;
          esac
