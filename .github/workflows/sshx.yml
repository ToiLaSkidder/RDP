name: üöÄ SSHX ULTIMATE REFRESH

on:
  workflow_dispatch:
    inputs:
      duration:
        default: '12h'
        type: choice
        options: ['1h', '3h', '6h', '12h']

jobs:
  Deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: üì• CHECKOUT
        uses: actions/checkout@v4

      - name: üì• INSTALL SSHX
        run: |
          curl -sSf https://sshx.io/get | sh
          SSHX_BIN=$(which sshx || find $HOME -name sshx -type f | head -n 1)
          cp "$SSHX_BIN" ./sshx_bin

      - name: üåê GET CLEAN URL
        run: |
          sudo ./sshx_bin > sshx_log.txt 2>&1 &
          sleep 15
          # T·∫©y s·∫°ch m√£ m√†u ANSI v√† k√Ω t·ª± r√°c
          CLEAN_URL=$(grep -o 'https://sshx.io/s/[^[:space:]]*' sshx_log.txt | head -n 1 | sed 's/\x1b\[[0-9;]*m//g' | sed 's/[^a-zA-Z0-9#?=&/_.:-]*$//')
          echo "URL_FINAL=$CLEAN_URL" >> $GITHUB_ENV
          echo "‚úÖ URL M·ªõi: $CLEAN_URL"

      - name: ‚ö° SUPER FORCE PUSH
        run: |
          # 1. T·∫°o index.html v·ªõi k·ªπ thu·∫≠t Cache-Busting ƒëa t·∫ßng
          # S·ª≠ d·ª•ng tham s·ªë ?v=[timestamp] ƒë·ªÉ √©p CDN c·∫≠p nh·∫≠t
          cat <<EOF > index.html
          <!DOCTYPE html>
          <html>
          <head>
              <meta charset="UTF-8">
              <meta http-equiv="cache-control" content="no-cache, must-revalidate, post-check=0, pre-check=0">
              <meta http-equiv="expires" content="0">
              <meta http-equiv="pragma" content="no-cache">
              <title>Updating Terminal...</title>
              <script>
                  // Th√™m timestamp ng·∫´u nhi√™n v√†o link SSHX
                  const target = "${{ env.URL_FINAL }}";
                  const cleanTarget = target.split('?')[0] + "#" + target.split('#')[1];
                  
                  // Chuy·ªÉn h∆∞·ªõng ngay l·∫≠p t·ª©c
                  window.location.replace(cleanTarget);
              </script>
          </head>
          <body style="background:#000;color:#0f0;font-family:monospace;padding:20px;">
              > FORCE UPDATING VERSION: $(date +%s)...<br>
              > REDIRECTING TO: ${{ env.URL_FINAL }}
          </body>
          </html>
          EOF
          
          # 2. C·∫•u h√¨nh ƒë·ªãnh danh
          echo "sshx.nghuyzzz.qzz.io" > CNAME
          touch .nojekyll
          
          # 3. Git config
          git config --global user.name "ToiLaSkidder"
          git config --global user.email "ToiLaSkidder@users.noreply.github.com"
          
          # 4. CHI·∫æN THU·∫¨T: Reset ho√†n to√†n l·ªãch s·ª≠ nh√°nh gh-pages
          git checkout --orphan gh-pages-temp
          git rm -rf .
          git add index.html CNAME .nojekyll
          git commit -m "üöÄ Reset & Force Update: $(date +%s)"
          
          # ƒê·∫©y ƒë√® ƒë·ªÉ GitHub Pages ph·∫£i kh·ªüi ƒë·ªông l·∫°i quy tr√¨nh Deploy
          git push origin gh-pages-temp:gh-pages --force

      - name: ‚è≥ KEEP ALIVE
        run: |
          case "${{ github.event.inputs.duration }}" in
            "1h") sleep 3600 ;; "3h") sleep 10800 ;; "6h") sleep 21600 ;; "12h") sleep 43200 ;;
          esac
