name: üöÄ SSHX TERMINAL - WORKER REDIRECT (DYNAMIC TIME)

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'üïê Ch·ªçn th·ªùi gian duy tr√¨'
        required: false
        default: '12h'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '6h'
        - '12h'

jobs:
  SSHX-to-Worker:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• C√ÄI ƒê·∫∂T SSHX (B·∫¢N FIX)
        run: |
          # 1. X√≥a file l·ªói c≈© n·∫øu c√≥
          rm -rf sshx
          
          # 2. C√†i ƒë·∫∑t b·∫±ng script ch√≠nh ch·ªß
          curl -sSf https://sshx.io/get | sh
          
          # 3. T√¨m v√† copy file ch·∫°y ra th∆∞ m·ª•c hi·ªán t·∫°i
          # Script th∆∞·ªùng c√†i v√†o ~/.sshx/sshx ho·∫∑c /usr/local/bin/sshx
          if [ -f "$HOME/.sshx/sshx" ]; then
            cp "$HOME/.sshx/sshx" .
            echo "‚úÖ ƒê√£ l·∫•y file t·ª´ th∆∞ m·ª•c Home"
          elif [ -f "/usr/local/bin/sshx" ]; then
            cp "/usr/local/bin/sshx" .
            echo "‚úÖ ƒê√£ l·∫•y file t·ª´ /usr/local/bin"
          else
            # Tr∆∞·ªùng h·ª£p d·ª± ph√≤ng: T√¨m kh·∫Øp n∆°i
            find $HOME -name sshx -type f -exec cp {} . \; -quit
          fi
          
          # 4. C·∫•p quy·ªÅn ch·∫°y cho ch·∫Øc ch·∫Øn
          chmod +x ./sshx
          ls -lh ./sshx

- name: üåê KH·ªûI CH·∫†Y V√Ä C·∫¨P NH·∫¨T WORKER KV (FULL URL FIX)
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          KV_ID: ${{ secrets.KV_NAMESPACE_ID }}
        run: |
          # 1. Kh·ªüi ch·∫°y sshx
          ./sshx > sshx_log.txt 2>&1 &
          sleep 10
          
          # 2. Tr√≠ch xu·∫•t FULL URL (bao g·ªìm c·∫£ ph·∫ßn sau d·∫•u #)
          # S·ª≠ d·ª•ng regex r·ªông h∆°n ƒë·ªÉ l·∫•y ƒë·∫øn h·∫øt d√≤ng
          SSHX_URL=$(grep -o 'https://sshx.io/s/[^ ]*' sshx_log.txt | head -n 1)
          
          if [ -z "$SSHX_URL" ]; then
            echo "‚ùå L·ªói: Kh√¥ng t√¨m th·∫•y URL!"
            exit 1
          fi

          echo "üîó URL ƒê·∫ßy ƒë·ªß t√¨m th·∫•y: $SSHX_URL"

          # 3. ƒê·∫©y URL l√™n Cloudflare KV (B·∫Øt bu·ªôc d√πng d·∫•u ngo·∫∑c k√©p "$SSHX_URL")
          # Vi·ªác d√πng d·∫•u ngo·∫∑c k√©p gi√∫p gi·ªØ nguy√™n c√°c k√Ω t·ª± ƒë·∫∑c bi·ªát nh∆∞ #
          curl -s -X PUT "https://api.cloudflare.com/client/v4/accounts/$CF_ACCOUNT_ID/storage/kv/namespaces/$KV_ID/values/LATEST_URL" \
            -H "Authorization: Bearer $CF_API_TOKEN" \
            -H "Content-Type: text/plain" \
            --data "$SSHX_URL"
          
          echo "‚úÖ ƒê√£ c·∫≠p nh·∫≠t FULL URL l√™n Worker th√†nh c√¥ng!"
