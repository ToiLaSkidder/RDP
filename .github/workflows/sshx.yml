name: üöÄ SSHX TERMINAL - FULL REDIRECT

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'üïê Ch·ªçn th·ªùi gian duy tr√¨'
        required: false
        default: '12h'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '6h'
        - '12h'

jobs:
  SSHX-to-Worker:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• C√ÄI ƒê·∫∂T SSHX (STABLE VERSION)
        run: |
          curl -sSf https://sshx.io/get | sh
          # Copy file ra th∆∞ m·ª•c hi·ªán t·∫°i ƒë·ªÉ d·ªÖ g·ªçi l·ªánh
          if [ -f "$HOME/.sshx/sshx" ]; then
            cp "$HOME/.sshx/sshx" .
          else
            find $HOME -name sshx -type f -exec cp {} . \; -quit
          fi
          chmod +x ./sshx

      - name: üåê KH·ªûI CH·∫†Y V√Ä C·∫¨P NH·∫¨T WORKER KV
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          KV_ID: ${{ secrets.KV_NAMESPACE_ID }}
        run: |
          # 1. Kh·ªüi ch·∫°y sshx v√† l∆∞u log
          ./sshx > sshx_log.txt 2>&1 &
          
          echo "‚è≥ ƒêang ƒë·ª£i SSHX t·∫°o link b·∫£o m·∫≠t..."
          sleep 12
          
          # 2. Tr√≠ch xu·∫•t FULL URL (L·∫•y to√†n b·ªô d√≤ng ch·ª©a link ƒë·ªÉ kh√¥ng m·∫•t ph·∫ßn sau d·∫•u #)
          # S·ª≠ d·ª•ng Regex l·∫•y m·ªçi k√Ω t·ª± kh√¥ng ph·∫£i kho·∫£ng tr·∫Øng sau https://sshx.io/s/
          SSHX_URL=$(grep -o 'https://sshx.io/s/[^[:space:]]*' sshx_log.txt | head -n 1)
          
          if [ -z "$SSHX_URL" ]; then
            echo "‚ùå L·ªñI: Kh√¥ng t√¨m th·∫•y URL trong log!"
            cat sshx_log.txt
            exit 1
          fi

          echo "‚úÖ ƒê√£ l·∫•y URL ƒë·∫ßy ƒë·ªß: $SSHX_URL"

          # 3. ƒê·∫©y URL l√™n Cloudflare KV
          # Quan tr·ªçng: D√πng "$SSHX_URL" trong d·∫•u ngo·∫∑c k√©p ƒë·ªÉ gi·ªØ k√Ω t·ª± #
          curl -s -X PUT "https://api.cloudflare.com/client/v4/accounts/$CF_ACCOUNT_ID/storage/kv/namespaces/$KV_ID/values/LATEST_URL" \
            -H "Authorization: Bearer $CF_API_TOKEN" \
            -H "Content-Type: text/plain" \
            --data "$SSHX_URL"
          
          echo "üéâ ƒê√£ c·∫≠p nh·∫≠t th√†nh c√¥ng! Truy c·∫≠p ngay domain c·ªßa b·∫°n."

      - name: ‚è≥ DUY TR√å PHI√äN L√ÄM VI·ªÜC
        run: |
          DURATION="${{ github.event.inputs.duration }}"
          case $DURATION in
            "1h") sleep 3600 ;;
            "3h") sleep 10800 ;;
            "6h") sleep 21600 ;;
            "12h") sleep 43200 ;;
          esac
