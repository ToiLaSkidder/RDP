name: üöÄ SSHX FIXED URL FOR TOILASKIDDER

on:
  workflow_dispatch:
    inputs:
      duration:
        default: '12h'
        type: choice
        options: ['1h', '3h', '6h', '12h']

jobs:
  Deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      
    steps:
      - name: üì• CHECKOUT
        uses: actions/checkout@v4

      - name: üì• INSTALL SSHX
        run: |
          curl -sSf https://sshx.io/get | sh
          # T√¨m file bin ch√≠nh x√°c
          SSHX_BIN=$(which sshx || find $HOME -name sshx -type f | head -n 1)
          cp "$SSHX_BIN" ./sshx_bin

      - name: üåê RUN ROOT & CAPTURE FULL URL
        run: |
          # Ch·∫°y sudo v√† b·∫Øt log
          sudo ./sshx_bin > sshx_log.txt 2>&1 &
          
          echo "‚è≥ ƒêang ƒë·ª£i link (15s)..."
          sleep 15
          
          # S·ª≠ d·ª•ng regex m·∫°nh h∆°n ƒë·ªÉ l·∫•y to√†n b·ªô URL k·ªÉ c·∫£ d·∫•u #
          # grep -oP y√™u c·∫ßu Perl-style regex ƒë·ªÉ b·∫Øt ch√≠nh x√°c c√°c k√Ω t·ª± ƒë·∫∑c bi·ªát
          RAW_URL=$(grep -o 'https://sshx.io/s/[^[:space:]]*' sshx_log.txt | head -n 1)
          
          if [ -z "$RAW_URL" ]; then
            echo "‚ùå Kh√¥ng t√¨m th·∫•y URL!"
            cat sshx_log.txt
            exit 1
          fi

          echo "‚úÖ ƒê√£ b·∫Øt ƒë∆∞·ª£c URL: $RAW_URL"
          # L∆∞u v√†o file thay v√¨ bi·∫øn env ƒë·ªÉ tr√°nh l·ªói escape k√Ω t·ª± l·∫°
          echo "$RAW_URL" > url_source.txt

      - name: ‚ö° PUSH TO GH-PAGES
        run: |
          # ƒê·ªçc URL t·ª´ file
          SSHX_URL=$(cat url_source.txt)
          
          # T·∫°o index.html s·ª≠ d·ª•ng template literal ƒë·ªÉ tr√°nh l·ªói d·∫•u nh√°y
          echo "<html><head><script>location.replace(\"$SSHX_URL\")</script></head></html>" > index.html
          
          echo "sshx.nghuyzzz.qzz.io" > CNAME
          touch .nojekyll
          
          git config --global user.name "ToiLaSkidder"
          git config --global user.email "ToiLaSkidder@users.noreply.github.com"
          
          git checkout --orphan gh-pages
          git rm -rf .
          git add index.html CNAME .nojekyll
          git commit -m "üöÄ Terminal Fixed URL: $(date)"
          git push origin gh-pages --force

      - name: ‚è≥ KEEP ALIVE
        run: |
          case "${{ github.event.inputs.duration }}" in
            "1h") sleep 3600 ;; "3h") sleep 10800 ;; "6h") sleep 21600 ;; "12h") sleep 43200 ;;
          esac
