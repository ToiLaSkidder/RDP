name: üöÄ SSHX TERMINAL - FULL REDIRECT

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'üïê Ch·ªçn th·ªùi gian duy tr√¨'
        required: false
        default: '12h'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '6h'
        - '12h'

jobs:
  SSHX-to-Worker:
    runs-on: ubuntu-latest
    
    steps:
      - name: üì• C√ÄI ƒê·∫∂T SSHX (STABLE VERSION)
        run: |
          curl -sSf https://sshx.io/get | sh
          # Copy file ra th∆∞ m·ª•c hi·ªán t·∫°i ƒë·ªÉ d·ªÖ g·ªçi l·ªánh
          if [ -f "$HOME/.sshx/sshx" ]; then
            cp "$HOME/.sshx/sshx" .
          else
            find $HOME -name sshx -type f -exec cp {} . \; -quit
          fi
          chmod +x ./sshx
- name: üåê KH·ªûI CH·∫†Y SSHX V·ªöI QUY·ªÄN ROOT
        env:
          CF_API_TOKEN: ${{ secrets.CF_API_TOKEN }}
          CF_ACCOUNT_ID: ${{ secrets.CF_ACCOUNT_ID }}
          KV_ID: ${{ secrets.KV_NAMESPACE_ID }}
        run: |
          # 1. Kh·ªüi ch·∫°y sshx d∆∞·ªõi quy·ªÅn sudo ƒë·ªÉ c√≥ quy·ªÅn Root ngay khi truy c·∫≠p
          # D√πng 'sudo -E' ƒë·ªÉ gi·ªØ c√°c bi·∫øn m√¥i tr∆∞·ªùng n·∫øu c·∫ßn
          sudo ./sshx > sshx_log.txt 2>&1 &
          
          echo "‚è≥ ƒêang kh·ªüi t·∫°o Terminal Root..."
          sleep 12
          
          # 2. Tr√≠ch xu·∫•t FULL URL (bao g·ªìm ph·∫ßn x√°c th·ª±c sau d·∫•u #)
          SSHX_URL=$(grep -o 'https://sshx.io/s/[^[:space:]]*' sshx_log.txt | head -n 1)
          
          if [ -z "$SSHX_URL" ]; then
            echo "‚ùå L·ªñI: Kh√¥ng l·∫•y ƒë∆∞·ª£c URL!"
            cat sshx_log.txt
            exit 1
          fi

          echo "‚úÖ URL Root: $SSHX_URL"

          # 3. ƒê·∫©y URL l√™n Cloudflare KV
          curl -s -X PUT "https://api.cloudflare.com/client/v4/accounts/$CF_ACCOUNT_ID/storage/kv/namespaces/$KV_ID/values/LATEST_URL" `
            -H "Authorization: Bearer $CF_API_TOKEN" `
            -H "Content-Type: text/plain" `
            --data "$SSHX_URL"
          
          echo "üéâ ƒê√£ xong! B√¢y gi·ªù khi v√†o domain, b·∫°n s·∫Ω th·∫•y d·∫•u '#' (Root) thay v√¨ '$' (User)."

      - name: ‚è≥ DUY TR√å PHI√äN L√ÄM VI·ªÜC
        run: |
          DURATION="${{ github.event.inputs.duration }}"
          case $DURATION in
            "1h") sleep 3600 ;;
            "3h") sleep 10800 ;;
            "6h") sleep 21600 ;;
            "12h") sleep 43200 ;;
          esac
