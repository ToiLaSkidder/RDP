name: üöÄ SEVER AI STV PREMIUM - 12H NGROK EDITION

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'üïê Th·ªùi gian s·ª≠ d·ª•ng'
        required: false
        default: '12h'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '6h'
        - '12h'

jobs:
  Premium-RDP-Setup:
    runs-on: windows-latest
    timeout-minutes: 720 
    
    steps:
      - name: üéØ KH·ªûI ƒê·ªòNG H·ªÜ TH·ªêNG
        run: |
          Write-Host "`nü§ñ AI STV PREMIUM RDP SERVER (NGROK)" -ForegroundColor Yellow
          Write-Host "‚ö° Powered by AI STV" -ForegroundColor Green
          Write-Host "üïí Th·ªùi gian: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta
          
      - name: üîß C·∫§U H√åNH H·ªÜ TH·ªêNG RDP
        run: |
          Write-Host "üõ†Ô∏è ƒêang c·∫•u h√¨nh Windows..." -ForegroundColor Yellow
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          netsh advfirewall firewall add rule name="RDP-Ngrok" dir=in action=allow protocol=TCP localport=3389 profile=any
          Start-Service -Name TermService -ErrorAction SilentlyContinue

      - name: üë§ T·∫†O T√ÄI KHO·∫¢N NGHUYZZZ
        run: |
          Write-Host "`nüë§ ƒêANG T·∫†O USER: nghuyzzz" -ForegroundColor Yellow
          $matKhau = "Huyngu67@" 
          $securePass = ConvertTo-SecureString $matKhau -AsPlainText -Force
          
          Remove-LocalUser -Name "nghuyzzz" -ErrorAction SilentlyContinue
          New-LocalUser -Name "nghuyzzz" -Password $securePass -AccountNeverExpires -Description "AI STV Premium Admin"
          Set-LocalUser -Name "nghuyzzz" -PasswordNeverExpires $true
          
          Add-LocalGroupMember -Group "Administrators" -Member "nghuyzzz"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "nghuyzzz"
          Write-Host "‚îÇ ‚úÖ User: nghuyzzz | Pass: Huyngu67@" -ForegroundColor Green

      - name: üåê THI·∫æT L·∫¨P NGROK TUNNEL
        env:
          NGROK_AUTH_TOKEN: ${{ secrets.NGROK_AUTH_TOKEN }}
        run: |
          Write-Host "`nüåê ƒêANG C√ÄI ƒê·∫∂T NGROK..." -ForegroundColor Yellow
          Invoke-WebRequest https://bin.equinox.io/c/b34edq6tiW5/ngrok-v3-stable-windows-amd64.zip -OutFile ngrok.zip
          Expand-Archive ngrok.zip -DestinationPath .
          
          Write-Host "üîó ƒêang kh·ªüi t·∫°o Tunnel..." -ForegroundColor Blue
          .\ngrok.exe config add-authtoken $env:NGROK_AUTH_TOKEN
          
          # Ch·∫°y ngrok ·ªü ch·∫ø ƒë·ªô n·ªÅn
          Start-Process .\ngrok.exe -ArgumentList "tcp 3389" -WindowStyle Hidden
          
          # ƒê·ª£i ngrok l·∫•y ƒë·ªãa ch·ªâ IP c√¥ng khai
          Start-Sleep -Seconds 10
          $ngrokUrl = (Invoke-RestMethod http://localhost:4040/api/tunnels).tunnels.public_url
          
          if ($ngrokUrl) {
              $cleanUrl = $ngrokUrl.Replace("tcp://", "")
              echo "NGROK_ADDRESS=$cleanUrl" >> $env:GITHUB_ENV
              Write-Host "‚îÇ ‚úÖ ƒê·ªãa ch·ªâ k·∫øt n·ªëi: $cleanUrl" -ForegroundColor Green
          } else {
              Write-Host "‚îÇ ‚ùå L·ªói: Kh√¥ng th·ªÉ l·∫•y ƒë·ªãa ch·ªâ Ngrok. H√£y ki·ªÉm tra Auth Token!" -ForegroundColor Red
              exit 1
          }

      - name: üéâ TH√îNG TIN K·∫æT N·ªêI
        run: |
          $durationInput = "${{ github.event.inputs.duration }}"
          switch ($durationInput) {
              "1h" { $totalMinutes = 60 }
              "3h" { $totalMinutes = 180 }
              "6h" { $totalMinutes = 360 }
              "12h" { $totalMinutes = 720 }
          }
          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $endTime = ([System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)).AddMinutes($totalMinutes)
          
          Write-Host "`n‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê" -ForegroundColor Cyan
          Write-Host "‚îÇ              üéâ K·∫æT N·ªêI S·∫¥N S√ÄNG!                ‚îÇ" -ForegroundColor Cyan
          Write-Host "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§" -ForegroundColor Cyan
          Write-Host "‚îÇ üåê  ƒê·ªãa ch·ªâ: $env:NGROK_ADDRESS" -ForegroundColor White
          Write-Host "‚îÇ üë§  T√†i kho·∫£n: nghuyzzz" -ForegroundColor White
          Write-Host "‚îÇ üîê  M·∫≠t kh·∫©u: Huyngu67@" -ForegroundColor White
          Write-Host "‚îÇ ‚è∞  K·∫øt th√∫c: $($endTime.ToString('HH:mm:ss dd/MM'))" -ForegroundColor Yellow
          Write-Host "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§" -ForegroundColor Cyan
          Write-Host "‚îÇ üí°  HD: D√°n ƒë·ªãa ch·ªâ tr√™n v√†o Remote Desktop   ‚îÇ" -ForegroundColor Gray
          Write-Host "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò" -ForegroundColor Cyan
          echo "TOTAL_MINUTES=$totalMinutes" >> $env:GITHUB_ENV

      - name: ‚è≥ DUY TR√å PHI√äN L√ÄM VI·ªÜC
        run: |
          $totalMinutes = $env:TOTAL_MINUTES
          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $endTime = ([System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)).AddMinutes($totalMinutes)
          
          # Gi√°m s√°t d·ªãch v·ª• TermService ng·∫ßm
          Start-Job -ScriptBlock { while($true){ if((Get-Service TermService).Status -ne 'Running'){Start-Service TermService}; Start-Sleep 30 } }

          $frames = @('‚†ã', '‚†ô', '‚†π', '‚†∏', '‚†º', '‚†¥', '‚†¶', '‚†ß', '‚†á', '‚†è')
          $i = 0
          while ($true) {
              $now = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
              $left = $endTime - $now
              if ($left.TotalSeconds -le 0) { break }
              
              $frame = $frames[$i % $frames.Length]
              Write-Host ("`r$frame C√≤n l·∫°i: {0:D2}h {1:D2}m {2:D2}s" -f $left.Hours, $left.Minutes, $left.Seconds) -NoNewline -ForegroundColor Cyan
              $i++
              Start-Sleep -Seconds 1
          }
          Write-Host "`nüéØ ƒê√É H·∫æT TH·ªúI GIAN!" -ForegroundColor Red

      - name: üßπ D·ªåN D·∫∏P
        if: always()
        run: |
          Stop-Process -Name ngrok -ErrorAction SilentlyContinue
          Get-Job | Stop-Job | Remove-Job
          Write-Host "üéâ H·ªá th·ªëng ƒë√£ ƒë√≥ng." -ForegroundColor Green
