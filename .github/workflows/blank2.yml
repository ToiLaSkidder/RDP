name: üöÄ SEVER AI STV PREMIUM - 12H EDITION

on:
  workflow_dispatch:
    inputs:
      duration:
        description: 'üïê Ch·ªçn th·ªùi gian s·ª≠ d·ª•ng'
        required: false
        default: '12h'
        type: choice
        options:
        - '1h'
        - '3h' 
        - '6h'
        - '12h'

jobs:
  Premium-RDP-Setup:
    runs-on: windows-latest
    timeout-minutes: 720 # Thi·∫øt l·∫≠p t·ªëi ƒëa 12 ti·∫øng
    
    steps:
      - name: üéØ KH·ªûI ƒê·ªòNG H·ªÜ TH·ªêNG
        run: |
          Write-Host "ü§ñ AI STV PREMIUM RDP SERVER" -ForegroundColor Yellow
          Write-Host "‚ö° Powered by AI STV" -ForegroundColor Green
          Write-Host "üïí Th·ªùi gian y√™u c·∫ßu: ${{ github.event.inputs.duration }}" -ForegroundColor Magenta
          Write-Host "üöÄ ƒêang chu·∫©n b·ªã m√¥i tr∆∞·ªùng..." -ForegroundColor Blue

      - name: üîß C·∫§U H√åNH H·ªÜ TH·ªêNG RDP
        run: |
          Write-Host "üõ†Ô∏è ƒêANG THI·∫æT L·∫¨P REGISTRY & FIREWALL..." -ForegroundColor Yellow
          # B·∫≠t RDP v√† b·ªè qua ki·ªÉm tra NLA ƒë·ªÉ k·∫øt n·ªëi d·ªÖ d√†ng h∆°n
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server' -Name "fDenyTSConnections" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "UserAuthentication" -Value 0 -Force
          Set-ItemProperty -Path 'HKLM:\System\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp' -Name "SecurityLayer" -Value 0 -Force
          
          # M·ªü Port Firewall
          netsh advfirewall firewall add rule name="RDP-Premium" dir=in action=allow protocol=TCP localport=3389 profile=any
          
          # Kh·ªüi ƒë·ªông d·ªãch v·ª•
          Start-Service -Name TermService -ErrorAction SilentlyContinue
          Write-Host "‚úÖ C·∫•u h√¨nh h·ªá th·ªëng ho√†n t·∫•t!" -ForegroundColor Green

      - name: üë§ T·∫†O T√ÄI KHO·∫¢N PREMIUM
        run: |
          Write-Host "üë§ ƒêANG T·∫†O USER: AISTV-PREMIUM" -ForegroundColor Yellow
          
          # T·∫°o m·∫≠t kh·∫©u ng·∫´u nhi√™n b·∫£o m·∫≠t
          $chars = "ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnpqrstuvwxyz23456789!@#$"
          $matKhau = -join ((1..12) | ForEach-Object { $chars[(Get-Random -Maximum $chars.Length)] })
          $securePass = ConvertTo-SecureString $matKhau -AsPlainText -Force
          
          # T·∫°o User
          New-LocalUser -Name "AISTV-PREMIUM" -Password $securePass -AccountNeverExpires -Description "AI STV Premium Account"
          Set-LocalUser -Name "AISTV-PREMIUM" -PasswordNeverExpires $true
          
          # C·∫•p quy·ªÅn
          Add-LocalGroupMember -Group "Administrators" -Member "AISTV-PREMIUM"
          Add-LocalGroupMember -Group "Remote Desktop Users" -Member "AISTV-PREMIUM"
          
          # L∆∞u th√¥ng tin v√†o m√¥i tr∆∞·ªùng
          echo "RDP_PASS=$matKhau" >> $env:GITHUB_ENV
          echo "$matKhau" > $env:TEMP\rdp_password.txt
          Write-Host "‚úÖ T√†i kho·∫£n ƒë√£ s·∫µn s√†ng!" -ForegroundColor Green

      - name: üåê THI·∫æT L·∫¨P M·∫†NG TAILSCALE
        env:
          TAILSCALE_AUTH_KEY: ${{ secrets.TAILSCALE_AUTH_KEY }}
        run: |
          Write-Host "üåê C√ÄI ƒê·∫∂T TAILSCALE..." -ForegroundColor Yellow
          $msiPath = "$env:TEMP\tailscale.msi"
          Invoke-WebRequest -Uri "https://pkgs.tailscale.com/stable/tailscale-setup-latest-amd64.msi" -OutFile $msiPath
          Start-Process msiexec.exe -ArgumentList "/i", "`"$msiPath`"", "/quiet", "/norestart" -Wait
          
          Write-Host "üîó ƒêang k·∫øt n·ªëi m·∫°ng..." -ForegroundColor Blue
          & "$env:ProgramFiles\Tailscale\tailscale.exe" up --authkey=$env:TAILSCALE_AUTH_KEY --hostname=ai-stv-premium-12h --reset
          
          # L·∫•y IP
          $ip = & "$env:ProgramFiles\Tailscale\tailscale.exe" ip -4
          echo "TAILSCALE_IP=$ip" >> $env:GITHUB_ENV
          Write-Host "‚úÖ IP C·ªßa b·∫°n: $ip" -ForegroundColor Green

      - name: üéâ TH√îNG TIN K·∫æT N·ªêI
        run: |
          $matKhau = Get-Content $env:TEMP\rdp_password.txt
          $durationInput = "${{ github.event.inputs.duration }}"
          
          switch ($durationInput) {
              "1h" { $totalMinutes = 60 }
              "3h" { $totalMinutes = 180 }
              "6h" { $totalMinutes = 360 }
              "12h" { $totalMinutes = 720 }
          }
          
          $timeZone = [System.TimeZoneInfo]::FindSystemTimeZoneById("SE Asia Standard Time")
          $startTime = [System.TimeZoneInfo]::ConvertTimeFromUtc((Get-Date).ToUniversalTime(), $timeZone)
          $endTime = $startTime.AddMinutes($totalMinutes)
          
          Write-Host ""
          Write-Host "‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê" -ForegroundColor Cyan
          Write-Host "‚îÇ          üöÄ AI STV PREMIUM 12H UP         ‚îÇ" -ForegroundColor Cyan
          Write-Host "‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§" -ForegroundColor Cyan
          Write-Host "‚îÇ üåê IP: $env:TAILSCALE_IP" -ForegroundColor White
          Write-Host "‚îÇ üë§ User: AISTV-PREMIUM" -ForegroundColor White
          Write-Host "‚îÇ üîê Pass: $matKhau" -ForegroundColor White
          Write-Host "‚îÇ ‚è∞ H·∫øt h·∫°n: $($endTime.ToString('HH:mm:ss dd/MM'))" -ForegroundColor Yellow
          Write-Host "‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò" -ForegroundColor Cyan
          
          echo "TOTAL_MINUTES=$totalMinutes" >> $env:GITHUB_ENV

      - name: ‚è≥ DUY TR√å PHI√äN L√ÄM VI·ªÜC
        run: |
          $totalMin = [int]$env:TOTAL_MINUTES
          $stopTime = (Get-Date).AddMinutes($totalMin)
          
          Write-Host "üîÑ H·ªá th·ªëng ƒëang ch·∫°y duy tr√¨..." -ForegroundColor Green
          
          while ((Get-Date) -lt $stopTime) {
              $remaining = $stopTime - (Get-Date)
              $timeStr = "{0:D2}h {1:D2}m {2:D2}s" -f $remaining.Hours, $remaining.Minutes, $remaining.Seconds
              Write-Host "`r‚è≥ Th·ªùi gian c√≤n l·∫°i: $timeStr " -NoNewline -ForegroundColor Cyan
              
              # NgƒÉn server sleep b·∫±ng c√°ch gi·∫£ l·∫≠p ph√≠m ·∫£o ho·∫∑c di chuy·ªÉn nh·∫π
              [void][System.Windows.Forms.SendKeys]::SendWait('{SCROLLLOCK}')
              
              Start-Sleep -Seconds 10
          }

      - name: üßπ D·ªåN D·∫∏P H·ªÜ TH·ªêNG
        if: always()
        run: |
          Write-Host "üßπ ƒêang ƒë√≥ng k·∫øt n·ªëi v√† d·ªçn d·∫πp..." -ForegroundColor Yellow
          & "$env:ProgramFiles\Tailscale\tailscale.exe" logout
          Remove-Item "$env:TEMP\rdp_password.txt" -ErrorAction SilentlyContinue
          Write-Host "‚úÖ ƒê√£ d·ªçn d·∫πp xong." -ForegroundColor Green
